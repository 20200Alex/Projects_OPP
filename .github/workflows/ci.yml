name: CI/CD Pipeline for Parallel Programming Project

on:
  push:
    branches: [ main, coder, tester, part2-openmp ]
  pull_request:
    branches: [ main ]

jobs:
  part1-threads:
    runs-on: ubuntu-22.04
    name: Part 1 - Threads (Knight Selection)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          g++ \
          build-essential \
          libgtest-dev \
          libgmock-dev
          
    - name: Build Google Test if needed
      run: |
        if [ ! -f "/usr/lib/libgtest.a" ] && [ ! -f "/usr/lib/x86_64-linux-gnu/libgtest.a" ]; then
          echo "Building Google Test from source..."
          cd /usr/src/gtest
          sudo cmake CMakeLists.txt
          sudo make
          sudo find . -name "*.a" -exec cp {} /usr/lib \;
          cd -
        fi
        
    - name: Configure and build Part 1
      run: |
        echo "Configuring CMake for Part 1 (Threads)..."
        mkdir -p build_part1
        cd build_part1
        
        # Указываем правильный путь к CMakeLists.txt в part1-threads
        cmake ../part1-threads -DBUILD_TESTS=ON
        
        echo "Building project..."
        make -j$(nproc)
        
        echo "Checking built files..."
        ls -la
        
    - name: Run tests for Part 1
      run: |
        cd build_part1
        
        echo "Looking for test executables..."
        # Ищем тестовый файл
        if [ -f "knight_selection_tests" ]; then
          echo "Found: ./knight_selection_tests"
          ./knight_selection_tests --gtest_color=yes --gtest_brief=1 || true
        elif [ -f "tests/knight_selection_tests" ]; then
          echo "Found: ./tests/knight_selection_tests"
          ./tests/knight_selection_tests --gtest_color=yes --gtest_brief=1 || true
        else
          echo "WARNING: Test executable not found!"
          echo "Directory structure:"
          find . -type f -executable
        fi
        
    - name: Run main application for Part 1
      run: |
        cd build_part1
        if [ -f "KnightSelectionApp" ]; then
          echo "Running main application..."
          timeout 3s ./KnightSelectionApp || echo "Application completed"
        else
          echo "WARNING: Main application not found"
        fi
        
  part2-openmp:
    runs-on: ubuntu-22.04
    name: Part 2 - OpenMP (Numerical Integration)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          g++ \
          build-essential \
          libomp-dev \
          libgtest-dev
          
    - name: Configure and build Part 2
      run: |
        echo "Configuring CMake for Part 2 (OpenMP)..."
        mkdir -p build_part2
        cd build_part2
        
        # Указываем правильный путь к CMakeLists.txt в part2-openmp
        cmake ../part2-openmp -DBUILD_TESTS=ON
        
        echo "Building project..."
        make -j$(nproc)
        
        echo "Checking built files..."
        ls -la
        
    - name: Run tests for Part 2
      run: |
        cd build_part2
        
        echo "Looking for test executables..."
        if [ -f "integral_tests" ]; then
          echo "Found: ./integral_tests"
          ./integral_tests --gtest_color=yes --gtest_brief=1 || true
        elif [ -f "tests/integral_tests" ]; then
          echo "Found: ./tests/integral_tests"
          ./tests/integral_tests --gtest_color=yes --gtest_brief=1 || true
        else
          echo "WARNING: Test executable not found for Part 2"
        fi
        
    - name: Run main application for Part 2
      run: |
        cd build_part2
        if [ -f "integral_app" ]; then
          echo "Running OpenMP integration application..."
          # Запускаем с меньшим количеством сегментов для быстрого теста
          timeout 10s ./integral_app 100000 1 2 || echo "Application completed or timed out"
        else
          echo "WARNING: OpenMP application not found"
        fi
        
  code-quality:
    runs-on: ubuntu-22.04
    name: Code Quality Analysis
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install analysis tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck
        
    - name: Run static analysis for Part 1
      run: |
        echo "Running cppcheck for Part 1 (Threads)..."
        if [ -d "part1-threads/src" ]; then
          cppcheck \
            --enable=warning,style,performance \
            --suppress=missingIncludeSystem \
            --error-exitcode=0 \
            part1-threads/src/ 2>&1 | tee cppcheck_part1.log || true
          
          echo "=== Cppcheck summary for Part 1 ==="
          grep -E "(error|warning|style):" cppcheck_part1.log | head -5 || true
        else
          echo "Part 1 source directory not found"
        fi
        
    - name: Run static analysis for Part 2
      run: |
        echo "Running cppcheck for Part 2 (OpenMP)..."
        if [ -d "part2-openmp/src" ]; then
          cppcheck \
            --enable=warning,style,performance \
            --suppress=missingIncludeSystem \
            --error-exitcode=0 \
            part2-openmp/src/ 2>&1 | tee cppcheck_part2.log || true
          
          echo "=== Cppcheck summary for Part 2 ==="
          grep -E "(error|warning|style):" cppcheck_part2.log | head -5 || true
        else
          echo "Part 2 source directory not found"
        fi
        
  coverage:
    runs-on: ubuntu-22.04
    name: Code Coverage
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install coverage tools
      run: |
        sudo apt-get update
        sudo apt-get install -y gcovr lcov
        
    - name: Build Part 1 with coverage
      run: |
        echo "Building Part 1 with coverage enabled..."
        
        # Переходим в директорию part1-threads
        cd part1-threads
        
        mkdir -p coverage_build
        cd coverage_build
        
        # Собираем с флагами покрытия
        cmake .. \
          -DBUILD_TESTS=ON \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage"
        
        make -j$(nproc)
        
        echo "Build completed. Files:"
        ls -la
        
    - name: Run tests for coverage
      run: |
        cd part1-threads/coverage_build
        echo "Running tests for coverage..."
        
        # Ищем и запускаем тесты
        if [ -f "knight_selection_tests" ]; then
          ./knight_selection_tests --gtest_color=yes --gtest_brief=1 || true
        elif [ -f "./tests/knight_selection_tests" ]; then
          ./tests/knight_selection_tests --gtest_color=yes --gtest_brief=1 || true
        else
          echo "WARNING: Test executable not found for coverage"
        fi
        
    - name: Generate coverage report
      run: |
        cd part1-threads/coverage_build
        echo "Generating coverage report..."
        
        # Генерируем отчет
        gcovr \
          --root .. \
          --exclude=".*/tests/.*" \
          --exclude=".*/coverage_build/.*" \
          --html \
          --html-details \
          --output=coverage_report.html \
          --print-summary || true
        
        echo "=== Coverage summary ==="
        gcovr --root .. --exclude=".*/tests/.*" --exclude=".*/coverage_build/.*" --print-summary || true
        
    - name: Upload coverage report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          part1-threads/coverage_build/coverage_report.html
        if-no-files-found: warn
        
  summary:
    runs-on: ubuntu-22.04
    name: Summary
    needs: [part1-threads, part2-openmp, code-quality, coverage]
    if: always()
    
    steps:
    - name: Display summary
      run: |
        echo "=== CI/CD Pipeline Summary ==="
        echo ""
        echo "Job Results:"
        echo "------------"
        echo "Part 1 (Threads): ${{ needs.part1-threads.result }}"
        echo "Part 2 (OpenMP): ${{ needs.part2-openmp.result }}"
        echo "Code Quality: ${{ needs.code-quality.result }}"
        echo "Coverage: ${{ needs.coverage.result }}"
        echo ""
        echo "=========================================="
        
        # Определяем общий статус
        if [[ "${{ needs.part1-threads.result }}" == "success" ]]; then
          echo "Part 1: SUCCESS"
        else
          echo "Part 1: FAILED"
        fi
        
        if [[ "${{ needs.part2-openmp.result }}" == "success" ]]; then
          echo "Part 2: SUCCESS"
        else
          echo "Part 2: ISSUES DETECTED"
        fi
          book-analyzer-tests:
    runs-on: ubuntu-22.04
    name: Part 2 - OpenMP Book Analyzer Tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          g++ \
          build-essential \
          libomp-dev \
          libgtest-dev
          
    - name: Build Google Test if needed
      run: |
        if [ ! -f "/usr/lib/libgtest.a" ] && [ ! -f "/usr/lib/x86_64-linux-gnu/libgtest.a" ]; then
          echo "Building Google Test from source..."
          cd /usr/src/gtest
          sudo cmake CMakeLists.txt
          sudo make
          sudo find . -name "*.a" -exec cp {} /usr/lib \;
          cd -
        fi
        
    - name: Configure and build book analyzer tests
      run: |
        echo "Configuring CMake for Book Analyzer..."
        mkdir -p build_book_analyzer
        cd build_book_analyzer
        
        cmake ../part2-openmp -DBUILD_TESTS=ON
        
        echo "Building project..."
        make -j$(nproc)
        
    - name: Run book analyzer tests
      run: |
        cd build_book_analyzer
        if [ -f "book_analysis_tests" ]; then
          echo "Running book analyzer tests..."
          ./book_analysis_tests --gtest_color=yes --gtest_brief=1
        else
          echo "ERROR: Test executable not found!"
          exit 1
        fi
