name: CI/CD Pipeline for Knight Selection Project

on:
  push:
    branches: [ main, coder, tester ]
  pull_request:
    branches: [ main ]

jobs:
  # Основная сборка и тестирование
  build-and-test:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          g++ \
          libgtest-dev \
          build-essential \
          pkg-config
          
    - name: Build and install GTest if needed
      run: |
        # Проверяем, установлен ли GTest
        if ! pkg-config --exists gtest; then
          echo "Building GTest from source..."
          sudo apt-get install -y libgtest-dev cmake
          cd /usr/src/gtest
          sudo cmake CMakeLists.txt
          sudo make
          sudo cp lib/*.a /usr/lib
          cd -
        fi
        
    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        cmake .. -DBUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Debug
        echo "CMake configuration completed with exit code: $?"
        
    - name: Build project
      run: |
        cd build
        make -j$(nproc)
        echo "Build completed with exit code: $?"
        
    - name: Run tests
      run: |
        cd build
        if [ -f "./tests/knight_selection_tests" ]; then
          ./tests/knight_selection_tests --gtest_color=yes
          TEST_EXIT_CODE=$?
          echo "Tests completed with exit code: $TEST_EXIT_CODE"
          exit $TEST_EXIT_CODE
        else
          echo "ERROR: Test executable not found!"
          ls -la ./tests/
          exit 1
        fi
        
    - name: Run main application
      run: |
        cd build
        if [ -f "./KnightSelectionApp" ]; then
          ./KnightSelectionApp
          echo "Main application completed with exit code: $?"
        else
          echo "WARNING: Main application executable not found!"
        fi
        
  # Проверка качества кода
  code-quality:
    runs-on: ubuntu-22.04
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install static analysis tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck clang-tidy valgrind
        
    - name: Static analysis with Cppcheck
      run: |
        cppcheck \
          --enable=all \
          --suppress=missingIncludeSystem \
          --suppress=unmatchedSuppression \
          --error-exitcode=1 \
          --inline-suppr \
          src/ 2> cppcheck_report.txt || true
        echo "=== Cppcheck Report ==="
        cat cppcheck_report.txt
        
    - name: Check for memory leaks (Valgrind)
      run: |
        mkdir -p build
        cd build
        cmake .. -DBUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Debug
        make -j$(nproc)
        
        if [ -f "./tests/knight_selection_tests" ]; then
          valgrind \
            --leak-check=full \
            --show-leak-kinds=all \
            --errors-for-leak-kinds=all \
            --error-exitcode=1 \
            ./tests/knight_selection_tests --gtest_repeat=1 2>&1 | tee valgrind_report.txt || true
          echo "=== Valgrind Report (summary) ==="
          grep -A5 -B5 "ERROR SUMMARY" valgrind_report.txt || true
        fi
        
    - name: Upload analysis reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: code-quality-reports
        path: |
          cppcheck_report.txt
          build/valgrind_report.txt
        
  # Покрытие кода
  coverage:
    runs-on: ubuntu-22.04
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install coverage tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcovr \
          lcov \
          gcc \
          g++
          
    - name: Build with coverage enabled
      run: |
        mkdir -p build_coverage
        cd build_coverage
        cmake .. \
          -DBUILD_TESTS=ON \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage"
        make -j$(nproc)
        
    - name: Run tests for coverage
      run: |
        cd build_coverage
        ./tests/knight_selection_tests --gtest_color=yes
        
    - name: Generate coverage report
      run: |
        cd build_coverage
        # Генерируем HTML отчет
        gcovr \
          --root .. \
          --exclude=".*/tests/.*" \
          --exclude=".*/build/.*" \
          --html \
          --html-details \
          --output=coverage_report.html \
          --print-summary
        
        # Генерируем XML отчет для интеграции
        gcovr \
          --root .. \
          --exclude=".*/tests/.*" \
          --exclude=".*/build/.*" \
          --xml \
          --output=coverage_report.xml
        
        echo "=== Coverage Summary ==="
        gcovr --root .. --exclude=".*/tests/.*" --exclude=".*/build/.*" --print-summary
        
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          build_coverage/coverage_report.html
          build_coverage/coverage_report.xml
          build_coverage/*.gcno
          build_coverage/*.gcda
    - name: Run tests with timeout protection
      run: |
        cd build
        echo "Running tests with 10-second timeout..."
        
        # Используем timeout для защиты от зависания
        timeout 10s ./tests/knight_selection_tests --gtest_color=yes --gtest_repeat=1 \
          --gtest_filter="*QuickTest:*SimpleSelection:*ConstructorTest" \
          || exit_code=$?
        
        if [ ${exit_code:-0} -eq 124 ]; then
          echo "ERROR: Tests timed out after 10 seconds"
          echo "This indicates a deadlock in the code"
          exit 1
        elif [ ${exit_code:-0} -ne 0 ]; then
          echo "Tests failed with exit code: ${exit_code}"
          exit ${exit_code}
        else
          echo "Tests completed successfully"
        fi
