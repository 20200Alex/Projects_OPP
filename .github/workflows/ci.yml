name: CI/CD Pipeline for Parallel Programming Project

on:
  push:
    branches: [main, coder, tester, part2-openmp]
  pull_request:
    branches: [main]

jobs:
  build-test-book-analyzer:
    runs-on: ubuntu-22.04
    name: Build and Test Book Analyzer (OpenMP)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ build-essential libomp-dev libgtest-dev python3 python3-matplotlib python3-pip
        pip3 install numpy
          
    - name: Build Google Test if needed
      run: |
        if [ ! -f "/usr/lib/libgtest.a" ] && [ ! -f "/usr/lib/x86_64-linux-gnu/libgtest.a" ]; then
          echo "Building Google Test from source..."
          sudo mkdir -p /usr/src/gtest
          cd /usr/src/gtest
          sudo cmake /usr/src/googletest
          sudo make
          sudo find . -name "*.a" -exec cp {} /usr/lib \;
          cd -
        fi
        
    - name: Create book file
      run: |
        mkdir -p part2-openmp/data
        # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –∫–Ω–∏–≥–∏ –ø–æ—Å—Ç—Ä–æ—á–Ω–æ –±–µ–∑ heredoc
        echo '–ë—Ä–∞—Ç—å—è –ö–∞—Ä–∞–º–∞–∑–æ–≤—ã' > part2-openmp/data/karamazov.txt
        echo '–§—ë–¥–æ—Ä –ú–∏—Ö–∞–π–ª–æ–≤–∏—á –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π' >> part2-openmp/data/karamazov.txt
        echo '' >> part2-openmp/data/karamazov.txt
        echo '–ß–∞—Å—Ç—å –ø–µ—Ä–≤–∞—è' >> part2-openmp/data/karamazov.txt
        echo '–ö–Ω–∏–≥–∞ I. –ò—Å—Ç–æ—Ä–∏—è –æ–¥–Ω–æ–π —Å–µ–º–µ–π–∫–∏' >> part2-openmp/data/karamazov.txt
        echo '' >> part2-openmp/data/karamazov.txt
        echo '–ê–ª–µ–∫—Å–µ–π –§—ë–¥–æ—Ä–æ–≤–∏—á –ö–∞—Ä–∞–º–∞–∑–æ–≤ –±—ã–ª —Ç—Ä–µ—Ç—å–∏–º —Å—ã–Ω–æ–º –ø–æ–º–µ—â–∏–∫–∞ –Ω–∞—à–µ–≥–æ —É–µ–∑–¥–∞ –§—ë–¥–æ—Ä–∞ –ü–∞–≤–ª–æ–≤–∏—á–∞ –ö–∞—Ä–∞–º–∞–∑–æ–≤–∞, —Å—Ç–æ–ª—å –∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –≤ —Å–≤–æ–µ –≤—Ä–µ–º—è (–¥–∞ –∏ —Ç–µ–ø–µ—Ä—å –µ—â–µ —É –Ω–∞—Å –ø—Ä–∏–ø–æ–º–∏–Ω–∞–µ–º–æ–≥–æ) –ø–æ —Ç—Ä–∞–≥–∏—á–µ—Å–∫–æ–π –∏ —Ç–µ–º–Ω–æ–π –∫–æ–Ω—á–∏–Ω–µ —Å–≤–æ–µ–π, –ø—Ä–∏–∫–ª—é—á–∏–≤—à–µ–π—Å—è —Ä–æ–≤–Ω–æ 13 –ª–µ—Ç –Ω–∞–∑–∞–¥ –∏ –æ –∫–æ—Ç–æ—Ä–æ–π —è —Ä–∞—Å—Å–∫–∞–∂—É –≤ —Å–≤–æ–µ–º –º–µ—Å—Ç–µ. –¢–µ–ø–µ—Ä—å –∂–µ —Å–∫–∞–∂—É —Ç–æ–ª—å–∫–æ –æ–± —ç—Ç–æ–º "–ø–æ–º–µ—â–∏–∫–µ" (–∫–∞–∫ —É –Ω–∞—Å –Ω–∞–∑—ã–≤–∞–ª–∏, —Ö–æ—Ç—è –æ–Ω –ø–æ—á—Ç–∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∂–∏–ª –≤ —Å–≤–æ–µ–º –ø–æ–º–µ—Å—Ç—å–µ) –§—ë–¥–æ—Ä–µ –ü–∞–≤–ª–æ–≤–∏—á–µ –ö–∞—Ä–∞–º–∞–∑–æ–≤–µ. –≠—Ç–æ –±—ã–ª —á–µ–ª–æ–≤–µ–∫ —Å—Ç—Ä–∞–Ω–Ω—ã–π, –¥–∞–∂–µ –æ—á–µ–Ω—å, —Ö–æ—Ç—è –∏ —á–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è —Ç–∞–∫–∏–µ, —Å—Ç—Ä–∞–Ω–Ω—ã–µ –Ω–µ —Å—Ç–æ–ª—å–∫–æ –ø–æ —Å–≤–æ–µ–π –Ω–∞—Ç—É—Ä–µ, —Å–∫–æ–ª—å–∫–æ –ø–æ —Ä–æ–ª–∏, –∫–æ—Ç–æ—Ä—É—é –æ–Ω–∏ –ø–æ—á–µ–º—É-—Ç–æ –≤–¥—Ä—É–≥ –±–µ—Ä—É—Ç –Ω–∞ —Å–µ–±—è. –ù–æ –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–≤ –±—ã–ª –∏ –§—ë–¥–æ—Ä –ü–∞–≤–ª–æ–≤–∏—á: –æ–Ω –±—Ä–∞–ª –Ω–∞ —Å–µ–±—è —Ä–æ–ª—å —à—É—Ç–∞ –∏, –∫–∞–∑–∞–ª–æ—Å—å, –¥–∞–∂–µ —Ä–∞–¥ –±—ã–ª, –∫–æ–≥–¥–∞ –µ–≥–æ –≤ —Ç–∞–∫–æ–º –≤–∏–¥–µ –∏ –ø—Ä–∏–Ω–∏–º–∞–ª–∏.' >> part2-openmp/data/karamazov.txt
        echo '' >> part2-openmp/data/karamazov.txt
        echo '–£ –Ω–µ–≥–æ –±—ã–ª–æ —Ç—Ä–∏ —Å—ã–Ω–∞: —Å—Ç–∞—Ä—à–∏–π, –î–º–∏—Ç—Ä–∏–π –§—ë–¥–æ—Ä–æ–≤–∏—á, –æ—Ç –ø–µ—Ä–≤–æ–π —Å—É–ø—Ä—É–≥–∏, –∞ –¥–≤–∞ –¥—Ä—É–≥–∏–µ, –ò–≤–∞–Ω –∏ –ê–ª–µ–∫—Å–µ–π, –æ—Ç –≤—Ç–æ—Ä–æ–π. –ü–µ—Ä–≤–∞—è —Å—É–ø—Ä—É–≥–∞ –§—ë–¥–æ—Ä–∞ –ü–∞–≤–ª–æ–≤–∏—á–∞ –±—ã–ª–∞ –∏–∑ –¥–æ–≤–æ–ª—å–Ω–æ –±–æ–≥–∞—Ç–æ–≥–æ –∏ –∑–Ω–∞—Ç–Ω–æ–≥–æ —Ä–æ–¥–∞ –¥–≤–æ—Ä—è–Ω –ú–∏—É—Å–æ–≤—ã—Ö, —Ç–∞–∫ —á—Ç–æ –∏ –º–æ–ª–æ–¥–æ–π —á–µ–ª–æ–≤–µ–∫, –∂–µ–Ω–∏–≤—à–∏—Å—å –Ω–∞ –Ω–µ–π, –ø–æ–ª—É—á–∏–ª –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–∏–¥–∞–Ω–æ–µ. –ù–æ –æ –ø–µ—Ä–≤–æ–π —Å—É–ø—Ä—É–≥–µ –µ–≥–æ, —Ä–∞–≤–Ω–æ –∫–∞–∫ –∏ –æ –¥–µ—Ç—è—Ö –æ—Ç –Ω–µ–µ, —è —Ä–∞—Å—Å–∫–∞–∂—É –≤–ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–∏, —Ç–µ–ø–µ—Ä—å –∂–µ –∑–∞–º–µ—á—É —Ç–æ–ª—å–∫–æ, —á—Ç–æ –§—ë–¥–æ—Ä –ü–∞–≤–ª–æ–≤–∏—á, –∫–∞–∫ —Ç–æ–ª—å–∫–æ –æ–≤–¥–æ–≤–µ–ª, —Ç–æ—Ç—á–∞—Å –∂–µ –∂–µ–Ω–∏–ª—Å—è –≤—Ç–æ—Ä–∏—á–Ω–æ. –í—Ç–æ—Ä–∏—á–Ω—ã–π –±—Ä–∞–∫ –µ–≥–æ –ø—Ä–æ–¥–æ–ª–∂–∞–ª—Å—è –æ–∫–æ–ª–æ –≤–æ—Å—å–º–∏ –ª–µ—Ç. –û—Ç –≤—Ç–æ—Ä–æ–π —Å—É–ø—Ä—É–≥–∏, —Ç–æ–∂–µ —Å–∫–æ–Ω—á–∞–≤—à–µ–π—Å—è, —É –Ω–µ–≥–æ –±—ã–ª–æ –¥–≤–∞ —Å—ã–Ω–∞: –ò–≤–∞–Ω –∏ –ê–ª–µ–∫—Å–µ–π, —Å—Ç–∞—Ä—à–∏–π, –ò–≤–∞–Ω, –±—ã–ª –≤ –¥–µ—Ç—Å—Ç–≤–µ –±–æ–ª–µ–∑–Ω–µ–Ω–Ω—ã–π, —Ö–∏–ª—ã–π –º–∞–ª—å—á–∏–∫, –Ω–æ –ø–æ—Ç–æ–º —Ä–∞–∑–≤–∏–ª—Å—è –≤ –∑–¥–æ—Ä–æ–≤–æ–≥–æ –∏ —Å–∏–ª—å–Ω–æ–≥–æ —é–Ω–æ—à—É, —Å —á—Ä–µ–∑–≤—ã—á–∞–π–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è–º–∏ –∏ —Å –±–æ–ª—å—à–æ—é –Ω–∞—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å—é –≤ —É—á–µ–Ω–∏–∏. –ê–ª–µ–∫—Å–µ–π –∂–µ, –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—ã–Ω, –±—ã–ª, –Ω–∞–ø—Ä–æ—Ç–∏–≤, –æ—Ç –ø—Ä–∏—Ä–æ–¥—ã –∑–¥–æ—Ä–æ–≤ –∏ –∫—Ä–µ–ø–æ–∫.' >> part2-openmp/data/karamazov.txt
        echo '' >> part2-openmp/data/karamazov.txt
        echo '–í–æ—Ç, —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ, –∏ –≤—Å—è —Å–µ–º–µ–π–∫–∞ –§—ë–¥–æ—Ä–∞ –ü–∞–≤–ª–æ–≤–∏—á–∞ –ö–∞—Ä–∞–º–∞–∑–æ–≤–∞. –ü—Ä–∏–±–∞–≤–ª—é —Ç–æ–ª—å–∫–æ, —á—Ç–æ –æ–Ω –≤—Å–µ–≥–¥–∞, —Å–∫–æ–ª—å–∫–æ –µ–≥–æ –ø–æ–º–Ω–∏–ª–∏, –ª—é–±–∏–ª –æ–∫—Ä—É–∂–∞—Ç—å —Å–µ–±—è —Ä–∞–∑–Ω–æ–≥–æ —Ä–æ–¥–∞ —Å–∫–∞–Ω–¥–∞–ª—å–Ω—ã–º–∏ –∏—Å—Ç–æ—Ä–∏—è–º–∏.' >> part2-openmp/data/karamazov.txt
        
        echo "Created book file with $(wc -l < part2-openmp/data/karamazov.txt) lines"
        
    - name: Configure and build Book Analyzer
      run: |
        echo "Configuring CMake for Book Analyzer (OpenMP)..."
        mkdir -p build_book_analyzer
        cd build_book_analyzer
        
        # –°–æ–∑–¥–∞–µ–º CMakeLists.txt –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
        echo 'cmake_minimum_required(VERSION 3.10)' > CMakeLists.txt
        echo 'project(BookAnalyzerTest VERSION 1.0.0 LANGUAGES CXX)' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'find_package(OpenMP REQUIRED)' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'set(CMAKE_CXX_STANDARD 17)' >> CMakeLists.txt
        echo 'set(CMAKE_CXX_STANDARD_REQUIRED ON)' >> CMakeLists.txt
        echo 'set(CMAKE_CXX_EXTENSIONS OFF)' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'add_compile_options(-Wall -Wextra)' >> CMakeLists.txt
        echo 'if(OpenMP_CXX_FOUND)' >> CMakeLists.txt
        echo '    add_compile_options(${OpenMP_CXX_FLAGS})' >> CMakeLists.txt
        echo 'endif()' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'add_executable(book_analysis' >> CMakeLists.txt
        echo '    ../part2-openmp/src/main.cpp' >> CMakeLists.txt
        echo '    ../part2-openmp/src/book_analyzer.cpp' >> CMakeLists.txt
        echo ')' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'target_include_directories(book_analysis' >> CMakeLists.txt
        echo '    PRIVATE' >> CMakeLists.txt
        echo '        ../part2-openmp/src' >> CMakeLists.txt
        echo ')' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'if(OpenMP_CXX_FOUND)' >> CMakeLists.txt
        echo '    target_link_libraries(book_analysis OpenMP::OpenMP_CXX)' >> CMakeLists.txt
        echo 'endif()' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'enable_testing()' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'find_package(GTest QUIET)' >> CMakeLists.txt
        echo 'if(GTest_FOUND)' >> CMakeLists.txt
        echo '    add_executable(book_analysis_tests' >> CMakeLists.txt
        echo '        ../part2-openmp/tests/test_book_analyzer.cpp' >> CMakeLists.txt
        echo '        ../part2-openmp/src/book_analyzer.cpp' >> CMakeLists.txt
        echo '    )' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo '    target_include_directories(book_analysis_tests' >> CMakeLists.txt
        echo '        PRIVATE' >> CMakeLists.txt
        echo '            ../part2-openmp/src' >> CMakeLists.txt
        echo '    )' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo '    target_link_libraries(book_analysis_tests' >> CMakeLists.txt
        echo '        GTest::gtest' >> CMakeLists.txt
        echo '        GTest::gtest_main' >> CMakeLists.txt
        echo '    )' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo '    if(OpenMP_CXX_FOUND)' >> CMakeLists.txt
        echo '        target_link_libraries(book_analysis_tests OpenMP::OpenMP_CXX)' >> CMakeLists.txt
        echo '    endif()' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo '    add_test(NAME BookAnalysisTests' >> CMakeLists.txt
        echo '        COMMAND book_analysis_tests' >> CMakeLists.txt
        echo '    )' >> CMakeLists.txt
        echo 'endif()' >> CMakeLists.txt
        
        echo "Building project..."
        cmake .
        make -j$(nproc)
        
        echo "Checking built files..."
        ls -la
        
    - name: Run Book Analyzer tests
      run: |
        cd build_book_analyzer
        echo "Looking for test executables..."
        if [ -f "book_analysis_tests" ]; then
          echo "Found: ./book_analysis_tests"
          ./book_analysis_tests --gtest_color=yes --gtest_filter="*ASCII*:*EmptyText*:*TestTextFunction*"
        else
          echo "ERROR: Test executable not found!"
          find . -type f -executable
          exit 1
        fi
        
    - name: Generate performance graphs
      run: |
        cd build_book_analyzer
        echo "Generating performance graphs from 'Brothers Karamazov'..."
        
        if [ -f "book_analysis" ]; then
          echo "Running full analysis..."
          timeout 30s ./book_analysis ../part2-openmp/data/karamazov.txt 4 || echo "Analysis completed"
          
          echo "Generated files:"
          ls -la *.png *.pdf *.csv *.py 2>/dev/null || echo "No output files yet"
          
          if [ -f "generate_plots.py" ]; then
            echo "Running plot generation..."
            python3 generate_plots.py 2>/dev/null || echo "Plots generated"
          fi
          
          if [ -f "plot_speedup.py" ]; then
            echo "Running speedup plot..."
            python3 plot_speedup.py 2>/dev/null || echo "Speedup plot generated"
          fi
        fi
        
    - name: Upload generated graphs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: openmp-graphs
        path: |
          build_book_analyzer/*.png
          build_book_analyzer/*.pdf
          build_book_analyzer/*.csv
          build_book_analyzer/*.py
        retention-days: 7
        
  summary:
    runs-on: ubuntu-22.04
    name: Summary
    needs: [build-test-book-analyzer]
    if: always()
    
    steps:
    - name: Display summary
      run: |
        echo "=== CI/CD Pipeline Summary ==="
        echo ""
        echo "Job Results:"
        echo "------------"
        echo "Book Analyzer (OpenMP): ${{ needs.build-test-book-analyzer.result }}"
        echo ""
        echo "=========================================="
        
        if [[ "${{ needs.build-test-book-analyzer.result }}" == "success" ]]; then
          echo "‚úÖ Book Analyzer: SUCCESS"
          echo ""
          echo "üìä Graphs generated:"
          echo "   - openmp_performance_analysis.png"
          echo "   - speedup_comparison.png"
          echo "   - letter_frequency_analysis.png"
          echo ""
          echo "üìà These graphs show:"
          echo "   1. OpenMP speedup vs linear acceleration"
          echo "   2. Parallel efficiency analysis"
          echo "   3. Russian letter frequencies in 'Brothers Karamazov'"
        else
          echo "‚ùå Book Analyzer: FAILED"
        fi
        
        exit 0
