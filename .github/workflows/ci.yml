name: CI/CD Pipeline for Parallel Programming Project

on:
  push:
    branches: [main, coder, tester, part2-openmp]
  pull_request:
    branches: [main]

jobs:
  build-test-book-analyzer:
    runs-on: ubuntu-22.04
    name: Build and Test Book Analyzer (OpenMP)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ build-essential libomp-dev libgtest-dev
          
    - name: Build Google Test if needed
      run: |
        if [ ! -f "/usr/lib/libgtest.a" ] && [ ! -f "/usr/lib/x86_64-linux-gnu/libgtest.a" ]; then
          echo "Building Google Test from source..."
          sudo mkdir -p /usr/src/gtest
          cd /usr/src/gtest
          sudo cmake /usr/src/googletest
          sudo make
          sudo find . -name "*.a" -exec cp {} /usr/lib \;
          cd -
        fi
        
        - name: Configure and build Book Analyzer
      run: |
        echo "Configuring CMake for Book Analyzer (OpenMP)..."
        mkdir -p build_book_analyzer
        cd build_book_analyzer
        
        # Создаем простой CMakeLists.txt без heredoc проблем
        echo 'cmake_minimum_required(VERSION 3.10)' > CMakeLists.txt
        echo 'project(BookAnalyzerTest VERSION 1.0.0 LANGUAGES CXX)' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'find_package(OpenMP REQUIRED)' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'set(CMAKE_CXX_STANDARD 17)' >> CMakeLists.txt
        echo 'set(CMAKE_CXX_STANDARD_REQUIRED ON)' >> CMakeLists.txt
        echo 'set(CMAKE_CXX_EXTENSIONS OFF)' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'add_compile_options(-Wall -Wextra)' >> CMakeLists.txt
        echo 'if(OpenMP_CXX_FOUND)' >> CMakeLists.txt
        echo '    add_compile_options(${OpenMP_CXX_FLAGS})' >> CMakeLists.txt
        echo 'endif()' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'add_executable(book_analysis' >> CMakeLists.txt
        echo '    ../part2-openmp/src/main.cpp' >> CMakeLists.txt
        echo '    ../part2-openmp/src/book_analyzer.cpp' >> CMakeLists.txt
        echo ')' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'target_include_directories(book_analysis' >> CMakeLists.txt
        echo '    PRIVATE' >> CMakeLists.txt
        echo '        ../part2-openmp/src' >> CMakeLists.txt
        echo ')' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'if(OpenMP_CXX_FOUND)' >> CMakeLists.txt
        echo '    target_link_libraries(book_analysis OpenMP::OpenMP_CXX)' >> CMakeLists.txt
        echo 'endif()' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'enable_testing()' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'find_package(GTest QUIET)' >> CMakeLists.txt
        echo 'if(GTest_FOUND)' >> CMakeLists.txt
        echo '    add_executable(book_analysis_tests' >> CMakeLists.txt
        echo '        ../part2-openmp/tests/test_book_analyzer.cpp' >> CMakeLists.txt
        echo '        ../part2-openmp/src/book_analyzer.cpp' >> CMakeLists.txt
        echo '    )' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo '    target_include_directories(book_analysis_tests' >> CMakeLists.txt
        echo '        PRIVATE' >> CMakeLists.txt
        echo '            ../part2-openmp/src' >> CMakeLists.txt
        echo '    )' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo '    target_link_libraries(book_analysis_tests' >> CMakeLists.txt
        echo '        GTest::gtest' >> CMakeLists.txt
        echo '        GTest::gtest_main' >> CMakeLists.txt
        echo '    )' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo '    if(OpenMP_CXX_FOUND)' >> CMakeLists.txt
        echo '        target_link_libraries(book_analysis_tests OpenMP::OpenMP_CXX)' >> CMakeLists.txt
        echo '    endif()' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo '    add_test(NAME BookAnalysisTests' >> CMakeLists.txt
        echo '        COMMAND book_analysis_tests' >> CMakeLists.txt
        echo '    )' >> CMakeLists.txt
        echo 'endif()' >> CMakeLists.txt
        
        echo "Building project..."
        cmake .  # Убрано -DBUILD_TESTS=ON
        make -j$(nproc)
        
    - name: Run Book Analyzer tests
      run: |
        cd build_book_analyzer
        
        echo "Looking for test executables..."
        if [ -f "book_analysis_tests" ]; then
          echo "Found: ./book_analysis_tests"
          ./book_analysis_tests --gtest_color=yes --gtest_brief=1
        else
          echo "ERROR: Test executable not found!"
          echo "Available files:"
          find . -type f -executable
          exit 1
        fi
        
    - name: Test basic functionality
      run: |
        cd build_book_analyzer
        echo "Testing basic functionality..."
        
        echo 'Это тестовый текст на русском языке.' > test_russian.txt
        echo 'Он содержит различные русские буквы.' >> test_russian.txt
        echo 'Алексей Фёдорович Карамазов был третьим сыном помещика нашего уезда.' >> test_russian.txt
        
        if [ -f "book_analysis" ]; then
          echo "Running book analysis on test file..."
          timeout 10s ./book_analysis test_russian.txt 1 || echo "Analysis completed"
        else
          echo "WARNING: Main application not found"
        fi

  part1-threads:
    runs-on: ubuntu-22.04
    name: Part 1 - Threads (Knight Selection)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ build-essential libgtest-dev
          
    - name: Build Google Test if needed
      run: |
        if [ ! -f "/usr/lib/libgtest.a" ] && [ ! -f "/usr/lib/x86_64-linux-gnu/libgtest.a" ]; then
          echo "Building Google Test from source..."
          sudo mkdir -p /usr/src/gtest
          cd /usr/src/gtest
          sudo cmake /usr/src/googletest
          sudo make
          sudo find . -name "*.a" -exec cp {} /usr/lib \;
          cd -
        fi
        
    - name: Configure and build Part 1
      run: |
        echo "Configuring CMake for Part 1 (Threads)..."
        mkdir -p build_part1
        cd build_part1
        
        # Создаем CMakeLists.txt без heredoc
        echo 'cmake_minimum_required(VERSION 3.10)' > CMakeLists.txt
        echo 'project(KnightSelection VERSION 1.0.0 LANGUAGES CXX)' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'set(CMAKE_CXX_STANDARD 17)' >> CMakeLists.txt
        echo 'set(CMAKE_CXX_STANDARD_REQUIRED ON)' >> CMakeLists.txt
        echo 'set(CMAKE_CXX_EXTENSIONS OFF)' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'add_compile_options(-Wall -Wextra -pthread)' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'add_executable(KnightSelectionApp' >> CMakeLists.txt
        echo '    ../part1-threads/src/main.cpp' >> CMakeLists.txt
        echo '    ../part1-threads/src/KnightSelection.cpp' >> CMakeLists.txt
        echo ')' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'target_include_directories(KnightSelectionApp' >> CMakeLists.txt
        echo '    PRIVATE' >> CMakeLists.txt
        echo '        ../part1-threads/src' >> CMakeLists.txt
        echo ')' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'find_package(Threads REQUIRED)' >> CMakeLists.txt
        echo 'target_link_libraries(KnightSelectionApp Threads::Threads)' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'enable_testing()' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo 'find_package(GTest QUIET)' >> CMakeLists.txt
        echo 'if(GTest_FOUND)' >> CMakeLists.txt
        echo '    add_executable(knight_selection_tests' >> CMakeLists.txt
        echo '        ../part1-threads/tests/test_knight_selection.cpp' >> CMakeLists.txt
        echo '        ../part1-threads/src/KnightSelection.cpp' >> CMakeLists.txt
        echo '    )' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo '    target_include_directories(knight_selection_tests' >> CMakeLists.txt
        echo '        PRIVATE' >> CMakeLists.txt
        echo '            ../part1-threads/src' >> CMakeLists.txt
        echo '    )' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo '    target_link_libraries(knight_selection_tests' >> CMakeLists.txt
        echo '        GTest::gtest' >> CMakeLists.txt
        echo '        GTest::gtest_main' >> CMakeLists.txt
        echo '        Threads::Threads' >> CMakeLists.txt
        echo '    )' >> CMakeLists.txt
        echo '' >> CMakeLists.txt
        echo '    add_test(NAME KnightSelectionTests' >> CMakeLists.txt
        echo '        COMMAND knight_selection_tests' >> CMakeLists.txt
        echo '    )' >> CMakeLists.txt
        echo 'endif()' >> CMakeLists.txt
        
        echo "Building project..."
        cmake .
        make -j$(nproc)
        
        echo "Checking built files..."
        ls -la
        
    - name: Run tests for Part 1
      run: |
        cd build_part1
        
        echo "Looking for test executables..."
        if [ -f "knight_selection_tests" ]; then
          echo "Found: ./knight_selection_tests"
          ./knight_selection_tests --gtest_color=yes --gtest_brief=1
        else
          echo "WARNING: Test executable not found!"
          find . -type f -executable
        fi
        
    - name: Run main application for Part 1
      run: |
        cd build_part1
        if [ -f "KnightSelectionApp" ]; then
          echo "Running main application..."
          timeout 3s ./KnightSelectionApp || echo "Application completed"
        else
          echo "WARNING: Main application not found"
        fi

  code-quality:
    runs-on: ubuntu-22.04
    name: Code Quality Analysis
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install analysis tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck clang-format
        
    - name: Check formatting for Book Analyzer
      run: |
        echo "Checking code formatting for Book Analyzer..."
        if [ -f "part2-openmp/src/book_analyzer.cpp" ]; then
          echo "Running clang-format check..."
          clang-format --style=Google -n part2-openmp/src/*.cpp part2-openmp/src/*.h 2>&1 || true
        fi
        
    - name: Run static analysis for Book Analyzer
      run: |
        echo "Running cppcheck for Book Analyzer..."
        if [ -d "part2-openmp/src" ]; then
          cppcheck --enable=warning,style,performance --suppress=missingIncludeSystem --error-exitcode=0 part2-openmp/src/ 2>&1 | tee cppcheck_book_analyzer.log || true
          echo "=== Cppcheck summary for Book Analyzer ==="
          grep -E "(error|warning|style):" cppcheck_book_analyzer.log | head -10 || true
        else
          echo "Book Analyzer source directory not found"
        fi
        
    - name: Run static analysis for Knight Selection
      run: |
        echo "Running cppcheck for Knight Selection..."
        if [ -d "part1-threads/src" ]; then
          cppcheck --enable=warning,style,performance --suppress=missingIncludeSystem --error-exitcode=0 part1-threads/src/ 2>&1 | tee cppcheck_knight.log || true
          echo "=== Cppcheck summary for Knight Selection ==="
          grep -E "(error|warning|style):" cppcheck_knight.log | head -10 || true
        else
          echo "Knight Selection source directory not found"
        fi

  summary:
    runs-on: ubuntu-22.04
    name: Summary
    needs: [build-test-book-analyzer, part1-threads, code-quality]
    if: always()
    
    steps:
    - name: Display summary
      run: |
        echo "=== CI/CD Pipeline Summary ==="
        echo ""
        echo "Job Results:"
        echo "------------"
        echo "Book Analyzer (OpenMP): ${{ needs.build-test-book-analyzer.result }}"
        echo "Knight Selection (Threads): ${{ needs.part1-threads.result }}"
        echo "Code Quality: ${{ needs.code-quality.result }}"
        echo ""
        echo "=========================================="
        
        if [[ "${{ needs.build-test-book-analyzer.result }}" == "success" ]]; then
          echo "Book Analyzer: SUCCESS ✓"
        else
          echo "Book Analyzer: FAILED ✗"
        fi
        
        if [[ "${{ needs.part1-threads.result }}" == "success" ]]; then
          echo "Knight Selection: SUCCESS ✓"
        else
          echo "Knight Selection: FAILED ✗"
        fi
        
        if [[ "${{ needs.code-quality.result }}" == "success" ]]; then
          echo "Code Quality: PASSED ✓"
        else
          echo "Code Quality: WARNINGS ⚠"
        fi
        
        echo ""
        echo "=== Detailed Status ==="
        exit 0
