name: CI/CD Pipeline for Knight Selection Project

on:
  push:
    branches: [ main, coder, tester ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          g++ \
          build-essential \
          libgtest-dev \
          libgmock-dev
          
    - name: Build Google Test if needed
      run: |
        if [ ! -f "/usr/lib/libgtest.a" ] && [ ! -f "/usr/lib/x86_64-linux-gnu/libgtest.a" ]; then
          echo "Building Google Test from source..."
          cd /usr/src/gtest
          sudo cmake CMakeLists.txt
          sudo make
          sudo find . -name "*.a" -exec cp {} /usr/lib \;
          cd -
        fi
        
    - name: Configure and build
      run: |
        echo "Configuring CMake..."
        mkdir -p build
        cd build
        cmake .. -DBUILD_TESTS=ON
        
        echo "Building project..."
        make -j$(nproc)
        
        echo "Checking built files..."
        find . -type f -name "*" | head -20
        
    - name: Run tests
      run: |
        cd build
        
        echo "Looking for test executables..."
        # Ищем тестовый файл в нескольких возможных местах
        if [ -f "knight_selection_tests" ]; then
          echo "Found: ./knight_selection_tests"
          ./knight_selection_tests --gtest_color=yes --gtest_brief=1
        elif [ -f "tests/knight_selection_tests" ]; then
          echo "Found: ./tests/knight_selection_tests"
          ./tests/knight_selection_tests --gtest_color=yes --gtest_brief=1
        else
          echo "ERROR: Test executable not found!"
          echo "Directory structure:"
          find . -type f -executable
          exit 1
        fi
        
    - name: Run main application
      run: |
        cd build
        if [ -f "KnightSelectionApp" ]; then
          echo "Running main application..."
          timeout 3s ./KnightSelectionApp || echo "Application completed"
        else
          echo "WARNING: Main application not found"
          find . -name "*KnightSelectionApp*" -type f
        fi
        
  code-quality:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install analysis tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck
        
    - name: Run static analysis
      run: |
        echo "Running cppcheck..."
        cppcheck \
          --enable=warning,style,performance \
          --suppress=missingIncludeSystem \
          --error-exitcode=0 \
          src/ 2>&1 | tee cppcheck.log
        
        echo "=== Cppcheck summary ==="
        grep -E "(error|warning|style):" cppcheck.log | head -10 || true
        
  coverage:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install coverage tools
      run: |
        sudo apt-get update
        sudo apt-get install -y gcovr lcov
        
    - name: Build with coverage
      run: |
        echo "Building with coverage enabled..."
        mkdir -p coverage_build
        cd coverage_build
        
        # Собираем с флагами покрытия
        cmake .. \
          -DBUILD_TESTS=ON \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage"
        
        make -j$(nproc)
        
        echo "Build completed. Files in coverage_build/:"
        find . -type f -name "*test*" -o -name "*Test*" | head -10
        
    - name: Run tests for coverage
      run: |
        cd coverage_build
        echo "Running tests for coverage..."
        
        # Ищем и запускаем тесты
        if [ -f "knight_selection_tests" ]; then
          ./knight_selection_tests --gtest_color=yes --gtest_brief=1
        elif [ -f "./tests/knight_selection_tests" ]; then
          ./tests/knight_selection_tests --gtest_color=yes --gtest_brief=1
        else
          echo "WARNING: Test executable not found in coverage_build/"
          echo "Available files:"
          find . -type f -executable
          # Не выходим с ошибкой, просто продолжаем
        fi
        
    - name: Generate coverage report
      run: |
        cd coverage_build
        echo "Generating coverage report..."
        
        # Генерируем отчет
        gcovr \
          --root .. \
          --exclude=".*/tests/.*" \
          --exclude=".*/coverage_build/.*" \
          --html \
          --html-details \
          --output=coverage_report.html \
          --print-summary
        
        echo "=== Coverage summary ==="
        gcovr --root .. --exclude=".*/tests/.*" --exclude=".*/coverage_build/.*" --print-summary
        
    - name: Upload coverage report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          coverage_build/coverage_report.html
